<tool id="hpc_msn_v_1_1" name="Mass Spectral Networking v. 1.1" version="1.0.0">
  <description></description>
    <command interpreter="python">hpc_msn.py "None" "$score_threshold" "$max_subnetwork_size" "$spectral_count_threshold" "$k_max_difference" "$k_max_relative_difference" "$same_mass_cosine_cutoff" "$k_rt_min" "$k_rt_max" "$half_isolation_width" "$precursor_intensity_cutoff" "$max_percent_base_peak" "$k_ms2_tolerance" "$exclude_singletons_from_network" "$annotation_database" $xgmml_outfile $console_outfile $cyjs_outfile $zip_output $project $dataset $files</command>
  <inputs>

    <param name="user_email" type="text" hidden="true"/>
    <param name="folder" type="select" label="FTP Folder" refresh_on_change="True" dynamic_options="get_ftp_folders(__trans__ , __trans__.user.email )" help="FTP folder." hidden="true" />
    <param name="project" type="select" label="Project" refresh_on_change="True" dynamic_options="get_ftp_folders(__trans__ , __trans__.user.email)" help="Available projects." />
    <param name="dataset" type="select" label="Dataset" refresh_on_change="True"  dynamic_options="get_ftp_raw_file_folders(__trans__.user.email, project)" help="Available datasets for selected project." />
    <param name="files" type="select" label="Input Files" refresh_on_change="True" multiple="true" dynamic_options="get_ftp_raw_files(__trans__.user.email, project, dataset)" help="Available raw/mzML files for selected project and dataset." />
    <param name="lib_name" type="text" value="" refresh_on_change="True" label="Library Name" hidden="true"/>
    <param name="lib_description" type="text" value="" refresh_on_change="True" label="Library Description" hidden="true"/>
    <param name="lib_synopsis" type="text" value="" refresh_on_change="True" label="Library Synopsis" hidden="true"/>
    <param name="permission_list" type="text" value="" refresh_on_change="True" label="Permissions" hidden="true"/>

    <param name="score_threshold" type="text" value="0.6" label="Edge Cosine Similarity Threshold"/>
    <param name="max_subnetwork_size" type="text" value="250" label="Max Molecular Family Size"/>
    <param name="spectral_count_threshold" type="text" value="2" label="Node Spectral Count Threshold"/>
    <param name="k_max_difference" type="text" value="0.0001" label="Identical m/z Tolerance (Th)"/>
    <param name="k_max_relative_difference" type="text" value="2E-05" label="Identical m/z Tolerance (ppm)"/>
    <param name="same_mass_cosine_cutoff" type="text" value="0.6" label="Node Cosine Score Threshold"/>
    <param name="k_rt_min" type="text" value="0" label="Retention Time Start"/>
    <param name="k_rt_max" type="text" value="100" label="Retention Time End"/>
    <param name="half_isolation_width" type="text" value="1.0" label="Isolation Window Half-Width"/>
<!--    <param name="kMass_of_a_roton" type="text" value="1.007276" label="k Mass Of A Proton"/>-->
    <param name="precursor_intensity_cutoff" type="text" value="30000.0" label="Precursor Intensity Threshold"/>
    <param name="max_percent_base_peak" type="text" value="0.75" label="MS/MS Mass-Normalized Intensity Threshold"/>
    <param name="k_ms2_tolerance" type="text" value="0.005" label="Identical MS2 Scan Tolerance (Th)"/>
    <param name="exclude_singletons_from_network" type="boolean" checked="false" label="Exclude Singletons rom Network" truevalue="True" falsevalue="False" />
    <param name="annotation_database" format="csv" type="data" label="Annotation Database"/>


  </inputs>
    <outputs>
        <data format="xgmml" name="xgmml_outfile" type="xgmml" label="Molecular Networking xgmml File"/>
        <data format="txt" name="console_outfile" type="text" label="Log File"/>
        <data format="json" name="cyjs_outfile" type="data" label="Cytoscape JSON"/>
        <data name="zip_output" format="zip"  type="data" label="Output Files ZIP"/>
    </outputs>
<!--<code file="/var/galaxy_dev/galaxy/tools/kelleher_tools/tool_form_utils_new.py" />-->
<code file="/var/galaxy_prod/galaxy/tools/kelleher_tools/tool_form_utils_new.py" />

  <tests>
    <test>
<!--      <param name="input1">
        <collection type="list">
          <element name="l11" value="simple_line.txt" />
          <element name="l12" value="simple_line.txt" />
        </collection>
      </param>
      <output_collection name="list_output" type="list">
        <element name="l11">
          <assert_contents>
            <has_text_matching expression="^identifier is l11\n$" />
          </assert_contents>
        </element>
        <element name="l12">
          <assert_contents>
            <has_text_matching expression="^identifier is l12\n$" />
          </assert_contents>
        </element>
      </output_collection>-->
    </test>
  </tests>

<help>
**What it does**

- Creates a mass spectral networking graph

**Input**

- Edge Cosine Similarity Threshold:  Threshold cosine score to make an edge
- Max Molecular Family Size:  Max number of nodes per cluster
- Node Spectral Count Threshold:  Threshold number of spectra needed to make a node
- Identical m/z Tolerance (Th):  When comparing m/z of 2 scans to remove duplicates, how close must they be absolutely in Th
- Identical m/z Tolerance (ppm):  When comparing m/z of 2 scans to remove duplicates, how close must they be relatively in ppm
- Node Cosine Score Threshold:  When removing duplicates, how good must the cosine score be to consider two nodes are duplicates. This happens after they are already close in m/z
- Retention Time Start:  Start retention time of input files
- Retention Time End: End retention time of input files
- Isolation Window Half-Width:  Parameter used to get precursor masses.
- Precursor Intesity Threshold:  Intensity required for a precursor ion to be included in the network
- MS/MS Mass-Normalized Intensity Threshold	when checking a scan for quality, ensures that the max normalized intensity is greater than this value. If not, sets "Shiftable" to true
- Identical MS2 Scan Tolerance (Th):  Error tolerance for two fragment ions to be considered the same between two MS2 spectra

**Output**

- xgmml file that can be viewed in Cytospace
- Cytoscape formatted json file that can be viewed in TDPortal
- log file
  </help>





</tool>


